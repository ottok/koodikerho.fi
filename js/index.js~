(function(){
    var stage, textStage, form, input;
    var circles, textPixels, textFormed;
    var offsetX, offsetY, text;
//    var colors = ['#B2949D', '#FFF578', '#FF5F8D', '#37A9CC', '#188EB2'];
    var colors = ['#d33', '#3d3', '#33d', '#dd3', '#3dd'];
    var textStyle = "400 100px 'Open Sans',sans-serif";

    function init() {
        initStages();
        initForm();
        initText();
        initCircles();
        animate();
        createText('KOODIKERHO.FI');
    }

    // Init Canvas
    function initStages() {
        offsetX = (window.innerWidth-800)/2;
        offsetY = (window.innerHeight-300)/2;
        textStage = new createjs.Stage("text");
        textStage.canvas.width = innerWidth;
        textStage.canvas.height = innerHeight;

        stage = new createjs.Stage("stage");
        stage.canvas.width = window.innerWidth;
        stage.canvas.height = window.innerHeight;
    }

    function initForm() {
        form = document.getElementById('form');
        form.style.top = offsetY+100+'px';
        form.style.left = offsetX+100+'px';
        input = document.getElementById('inputText');
    }

    function initText() {
        text = new createjs.Text("t", textStyle, "#fff");
   }

    function initCircles() {
        circles = [];
        for(var i=0; i<320; i++) {
            var circle = new createjs.Shape();
            var r = 8;
            var x = window.innerWidth*Math.random();
            var y = window.innerHeight*Math.random();
            var color = colors[Math.floor(i%colors.length)];
            var alpha = 0.2 + Math.random()*0.5;
            circle.alpha = alpha;
            circle.radius = r;
            circle.graphics.beginFill(color).drawCircle(0, 0, r);
            circle.x = x;
            circle.y = y;
            circles.push(circle);
            stage.addChild(circle);
        }
    }


    // animating circles
    function animate() {
        stage.update();
        requestAnimationFrame(animate);
    }

    function tweenCircle(c) {
	c.tween = TweenLite.to(c, 3, {x: c.originX, y: c.originY, ease:Quad.easeOut, alpha: 1, radius: 5, scaleX: 0.4, scaleY: 0.4, onComplete:
		function() {
			document.getElementById('form').style.opacity = 1;
		}
	});
    }

    function formText() {
        for(var i= 0, l=textPixels.length; i<l; i++) {
            circles[i].originX = offsetX + textPixels[i].x;
            circles[i].originY = offsetY + textPixels[i].y;
            tweenCircle(circles[i]);
        }
    }


    function createText(t) {
        text.text = t;
        text.font = textStyle;
        text.textAlign = 'center';
        text.x = 400;
        text.y = 0;
        textStage.addChild(text);
        textStage.update();

        var ctx = document.getElementById('text').getContext('2d');
        var pix = ctx.getImageData(0,0,800,200).data;
        textPixels = [];
        for (var i = pix.length; i >= 0; i -= 4) {
            if (pix[i] != 0) {
                var x = (i / 4) % 800;
                var y = Math.floor(Math.floor(i/800)/4);

                if((x && x%8 == 0) && (y && y%8 == 0)) textPixels.push({x: x, y: y});
            }
        }
	// console.log(textPixels.length);

        formText();
    }


    window.onload = function() { init() };
})();
